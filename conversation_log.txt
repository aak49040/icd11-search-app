## ICD検索システム 開発・運用ログ

### 1. 目的
ローカルで開発したICD検索システム（Next.js製）を、Vercelを利用してインターネット上に公開し、スマートフォンからQRコードでアクセスできるようにする。

### 2. 初回デプロイ作業ログ

#### 発生した問題と解決策

##### 問題1: ローカル開発サーバーが正常に起動しない
- **現象**: `npm run dev` を実行すると、ターミナル上は「Ready」と表示されるが、`http://localhost:3000` にアクセスすると「接続が拒否されました」と表示される。
- **原因**: Next.jsの高速化機能「Turbopack」とWindows環境の相性問題の可能性。
- **解決策**: `package.json` を編集し、`scripts`内の`"dev": "next dev --turbopack"` から `--turbopack`フラグを削除。これにより、通常の開発サーバーが起動し、問題が解決した。

##### 問題2: Vercelへのデプロイ時にビルドが失敗する
- **現象**: `vercel` コマンドでデプロイを実行した際、ビルド工程で `Failed to compile.` というエラーが発生。
- **原因**: TypeScriptの型チェックエラー。`src/app/api/search/route.ts` と `src/app/page.tsx` の2ファイルで、型が `any` になっている箇所が複数あったため。
- **解決策**:
    1.  `route.ts`内で、検索対象のデータ構造に合わせた `ICDItem` という型インターフェースを定義。`any` を `ICDItem` に置換。
    2.  `page.tsx`内でも同様に `ICDItem` インターフェースを定義し、検索結果を保持するstate (`results`) の型を `any[]` から `ICDItem[]` に変更。また、`catch`ブロックのエラーオブジェクトの型も修正。
    3.  修正後、再度 `vercel` を実行し、ビルドに成功。

##### 問題3: 本番サイトをスマートフォンで表示した際、入力文字が白色で見えにくい
- **現象**: スマートフォンのブラウザでサイトを開き、検索ボックスに文字を入力すると、背景色と文字色が近いため視認性が悪い。
- **原因**: 入力フィールドのCSSに文字色が明示的に指定されていなかった。
- **解決策**: `src/app/page.tsx` を編集し、検索ボックスの`<input>`タグの`className`に、文字色を濃いグレーにするTailwind CSSのクラス `text-gray-800` を追加。

### 初回デプロイ手順の概要

1.  **Vercel CLIのインストール**: `npm install -g vercel`
2.  **Vercelへのログイン**: `vercel login` (Emailでの認証を選択)
3.  **プレビュー環境へのデプロイ**: `vercel`
4.  **本番環境へのデプロイ**: `vercel --prod`

---

## 3. ICD11データの更新手順 (Git利用版)

プロジェクトがGit管理下に置かれたため、今後の更新は以下の手順で行います。

1.  **`icd_data.xlsx` の修正**:
    -   `C:\Users\cck59\psychiatry-handmade-accessory\icd_data.xlsx` をExcelなどの表計算ソフトで開きます。
    -   必要なデータを修正・追加・削除し、ファイルを上書き保存します。

2.  **データファイルの変換**:
    -   PowerShellまたはターミナルで `C:\Users\cck59\psychiatry-handmade-accessory` ディレクトリに移動します。
    -   以下のコマンドを順番に実行し、ExcelファイルからWebサイト用のJSONファイルを生成します。
        ```bash
        # Excel(.xlsx) から 中間ファイル(.csv)へ変換
        python convert_excel.py icd_data.xlsx temp_icd_data.csv

        # 中間ファイル(.csv) から Webサイト用のデータ(.json)へ変換
        python parse_icd_data.py
        ```

3.  **変更内容の記録 (Git)**:
    -   更新したファイルをGitに記録します。
    -   同じターミナルで、以下のコマンドを順番に実行します。
        ```bash
        # すべての変更をコミット対象に追加
        git add .

        # 変更内容をメッセージ付きで記録（"〇〇を更新" の部分は具体的な変更内容に書き換える）
        git commit -m "ICDデータを更新"
        ```

4.  **アプリケーションの再デプロイ**:
    -   更新内容をVercelに反映させます。
    -   同じターミナルで、以下のコマンドを実行します。
        ```bash
        vercel --prod
        ```
    -   このコマンドにより、Gitに記録された最新の状態がVercelにデプロイされ、Webサイトが更新されます。

### プロジェクト名の変更
- **旧プロジェクト名**: `handmade-accessory-shop`
- **新プロジェクト名**: `psychiatry-handmade-accessory`
- **変更理由**: プロジェクトの内容をより正確に反映するため。

### Git設定の経緯
- 初回デプロイ時はGit管理下になかったため、`vercel` コマンドで直接ファイルをアップロードする形式でデプロイが行われた。
- その後、何らかの経緯でプロジェクトがGitリポジトリとして初期化されたため、VercelがGitリポジトリとして認識するようになった。
- Gitリポジトリとして認識された場合、Vercelは最新のコミットをデプロイの基準とするため、ローカルでのファイル変更だけではデプロイに反映されなくなった。
- これにより、`git commit` が必須となり、Gitのユーザー情報（`user.name`, `user.email`）が未設定だったため、その設定が必要となった。
- 今後はGitを介した更新が推奨される。